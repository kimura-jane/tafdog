<!doctype html><meta charset="utf-8"><title>TAF DOG Mint</title>
<h1>TAF DOG Mint</h1>
<p><a href="/">← 戻る</a></p>
<label>数量 <input id="q" type="number" value="1" min="1" max="5"></label>
<button id="connect">Connect</button>
<button id="info">コントラクト確認</button>
<button id="mint">Mint</button>
<pre id="out"></pre>

<script type="module">
import { createWalletClient, createPublicClient, custom, parseAbi, formatEther } from 'https://esm.sh/viem@2?bundle';
import { polygon } from 'https://esm.sh/viem/chains?bundle';

// 置換不要（指定済み）
const NFT = '0xd0163c60bd67bbf0e3c1bdabae50277dffb5583b';
const SEADROP = '0x00005EA00Ac477B1030CE78506496e8C2dE24bf5';
const FEE_RECIPIENT = '0x8242dae5c6ff90b03d15c54cad95c3ed97ac0571';

const NFT_ABI = parseAbi([
  'function name() view returns (string)',
  'function symbol() view returns (string)',
  'function totalSupply() view returns (uint256)'
]);

const SD_ABI = parseAbi([
  'function getPublicDrop(address nft) view returns (tuple(uint80 mintPrice,uint48 startTime,uint48 endTime,uint16 maxTotalMintableByWallet,uint16 feeBps,bool restrictFeeRecipients))',
  'function mintPublic(address nft,address feeRecipient,uint256 quantity) payable'
]);

const out = m => document.getElementById('out').textContent = String(m ?? '');
const transport = custom(window.ethereum);
const pub = createPublicClient({ chain: polygon, transport });
const wal = createWalletClient({ chain: polygon, transport });

let account;

async function ensurePolygon(){
  const id = await window.ethereum.request({ method:'eth_chainId' });
  if (id !== '0x89')
    await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId:'0x89' }]});
}

document.getElementById('connect').onclick = async () => {
  if(!window.ethereum){ out('MetaMask未検出'); return; }
  [account] = await window.ethereum.request({ method:'eth_requestAccounts' });
  out('connected: ' + account);
};

document.getElementById('info').onclick = async () => {
  try{
    await ensurePolygon();
    const [name, symbol, total] = await Promise.all([
      pub.readContract({ address: NFT, abi: NFT_ABI, functionName:'name' }),
      pub.readContract({ address: NFT, abi: NFT_ABI, functionName:'symbol' }),
      pub.readContract({ address: NFT, abi: NFT_ABI, functionName:'totalSupply' }).catch(()=>null),
    ]);
    let priceWei = 0n, start=0n, end=0n, maxPerWallet=0n, feeBps=0n, restrict=false;
    try{
      const drop = await pub.readContract({ address: SEADROP, abi: SD_ABI, functionName:'getPublicDrop', args:[NFT] });
      priceWei = BigInt(drop.mintPrice ?? 0);
      start = BigInt(drop.startTime ?? 0);
      end = BigInt(drop.endTime ?? 0);
      maxPerWallet = BigInt(drop.maxTotalMintableByWallet ?? 0);
      feeBps = BigInt(drop.feeBps ?? 0);
      restrict = Boolean(drop.restrictFeeRecipients);
    }catch{}
    out(`name: ${name}
symbol: ${symbol}
totalSupply: ${total ?? 'unknown'}
price: ${priceWei} wei (${formatEther(priceWei)} MATIC)
start: ${start}  end: ${end}
max/wallet: ${maxPerWallet}  feeBps: ${feeBps}  restrictFeeRecipients: ${restrict}`);
  }catch(e){ out('読取失敗: ' + (e?.message || e)); }
};

document.getElementById('mint').onclick = async () => {
  try{
    await ensurePolygon();
    if(!account) [account] = await window.ethereum.request({ method:'eth_requestAccounts' });
    const qty = BigInt(Math.max(1, Number(document.getElementById('q').value|0)));

    // 価格取得（取得失敗時は0）
    let unit = 0n;
    try{
      const drop = await pub.readContract({ address: SEADROP, abi: SD_ABI, functionName:'getPublicDrop', args:[NFT] });
      unit = BigInt(drop.mintPrice ?? 0);
    }catch{}
    const value = unit * qty;

    const { request } = await pub.simulateContract({
      address: SEADROP,
      abi: SD_ABI,
      functionName: 'mintPublic',
      args: [NFT, FEE_RECIPIENT, qty],
      value,
      account
    });
    const tx = await wal.writeContract(request);
    out('tx: ' + tx);
  }catch(e){ out('error: ' + (e?.message || e)); }
};
</script>
