<script type="module">
import {ethers} from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";

const NFT = "0xd0163c60bd67bbf0e3c1bdabae50277dffb5583b";
const SD  = "0x00005EA00Ac477B1030CE78506496e8C2dE24bf5"; // SeaDrop(PoS)
const FEE = "0x8242dAe5C6fF90b03d15C54Cad95C3ed97AC0571"; // あなたの受取先

// 1) Polygonへ強制
const web3 = new ethers.providers.Web3Provider(window.ethereum, "any");
await web3.send("eth_requestAccounts", []);
await web3.send("wallet_switchEthereumChain", [{ chainId: "0x89" }]);
const signer = web3.getSigner();

// 2) 読み取りは公共RPC
const rpc = new ethers.providers.JsonRpcProvider("https://polygon-rpc.com");

// 3) 正しいABIでインスタンス
const NFT_ABI = [
  "function name() view returns(string)",
  "function symbol() view returns(string)",
  "function getMintStats() view returns (uint80,uint80,uint32,uint32,uint32,uint32,uint8,uint16)"
];
const SD_ABI = [
  "function isFeeRecipientAllowed(address,address) view returns (bool)",
  "function mintPublic(address nft,address feeRecipient,address minter,uint256 quantity) payable"
];

const nft = new ethers.Contract(NFT, NFT_ABI, rpc);
const sdRead = new ethers.Contract(SD, SD_ABI, rpc);      // read専用
const sdWrite = new ethers.Contract(SD, SD_ABI, signer);  // write専用

// 表示
const stats = await nft.getMintStats();
const allowed = await sdRead.isFeeRecipientAllowed(NFT, FEE)
  .catch(()=>false);
document.getElementById("info").textContent =
  `allowed(FEE_RECIPIENT): ${allowed}`;

// ミント
document.getElementById("btnMint").onclick = async () => {
  try {
    const qty = 1;
    // 必要なら gasLimit を手動指定
    await sdWrite.mintPublic(NFT, FEE, await signer.getAddress(), qty, { gasLimit: 500000 });
  } catch (e) {
    document.getElementById("log").textContent = e.message ?? String(e);
  }
};
</script>
