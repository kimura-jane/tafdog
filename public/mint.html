<!doctype html><meta charset="utf-8"><title>TAF DOG Mint</title>
<h1>TAF DOG</h1>
<p><a href="/">← 戻る</a></p>
<label>数量 <input id="q" type="number" value="1" min="1" max="5"></label>
<button id="connect">Connect</button>
<button id="probe">コントラクト確認</button>
<button id="mint">Mint</button>
<pre id="out"></pre>

<script type="module">
import { createWalletClient, createPublicClient, custom, parseAbi } from 'https://esm.sh/viem@2?bundle';
import { polygon } from 'https://esm.sh/viem/chains?bundle';

const CONTRACT = '0xd0163c60bd67bbf0e3c1bdabae50277dffb5583b';
const ABI = parseAbi([
  'function name() view returns (string)',
  'function symbol() view returns (string)',
  'function totalSupply() view returns (uint256)',
  'function price() view returns (uint256)',
  'function mintPrice() view returns (uint256)',
  'function publicPrice() view returns (uint256)',
  'function cost() view returns (uint256)',
  'function mint(uint256 quantity) payable',
  'function publicMint(uint256 quantity) payable',
  'function purchase(uint256 quantity) payable',
  'function mint() payable'
]);

const out = (m)=>document.getElementById('out').textContent = String(m ?? '');
const transport = custom(window.ethereum);
const publicClient = createPublicClient({ chain: polygon, transport });
const walletClient  = createWalletClient({ chain: polygon, transport });

let account;

async function ensurePolygon(){
  const id = await window.ethereum.request({ method:'eth_chainId' });
  if (id !== '0x89')
    await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId:'0x89' }]});
}

document.getElementById('connect').onclick = async () => {
  if(!window.ethereum){ out('MetaMask未検出'); return; }
  [account] = await window.ethereum.request({ method:'eth_requestAccounts' });
  out('connected: ' + account);
};

document.getElementById('probe').onclick = async () => {
  try{
    await ensurePolygon();
    const name   = await publicClient.readContract({ address: CONTRACT, abi: ABI, functionName:'name' });
    const symbol = await publicClient.readContract({ address: CONTRACT, abi: ABI, functionName:'symbol' });
    const total  = await publicClient.readContract({ address: CONTRACT, abi: ABI, functionName:'totalSupply' }).catch(()=>null);
    out(`name: ${name}\nsymbol: ${symbol}\ntotalSupply: ${total ?? 'unknown'}`);
  }catch(e){ out('読取失敗: ' + (e?.message || e)); }
};

async function getUnitPrice(){
  for (const f of ['price','mintPrice','publicPrice','cost']){
    try{ return BigInt(await publicClient.readContract({ address: CONTRACT, abi: ABI, functionName: f })); }
    catch{}
  }
  return 0n;
}

document.getElementById('mint').onclick = async () => {
  try{
    await ensurePolygon();
    if(!account) [account] = await window.ethereum.request({ method:'eth_requestAccounts' });
    const qty = BigInt(Math.max(1, Number(document.getElementById('q').value|0)));
    const value = (await getUnitPrice()) * qty;

    const plans = [
      { fn:'mint', args:[qty] },
      { fn:'publicMint', args:[qty] },
      { fn:'purchase', args:[qty] },
      { fn:'mint', args:[] }
    ];

    for(const p of plans){
      try{
        const { request } = await publicClient.simulateContract({
          address: CONTRACT, abi: ABI, functionName: p.fn, args: p.args, value, account
        });
        const tx = await walletClient.writeContract(request);
        out('tx: ' + tx);
        return;
      }catch{}
    }
    out('対応するミント関数なし（共有コントラクト等の可能性）');
  }catch(e){ out('error: ' + (e?.message || e)); }
};
</script>
