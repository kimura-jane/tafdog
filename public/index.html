<!doctype html><meta charset="utf-8"><title>TAF DOG Mint</title>
<h1>TAF DOG</h1>
<button id="connect">Connect</button>
<button id="probe">コントラクト確認</button>
<label>数量 <input id="q" type="number" value="1" min="1" max="5"></label>
<button id="mint">Mint</button>
<pre id="out"></pre>

<script type="module">
import { createWalletClient, custom, parseAbi, readContract, simulateContract, writeContract } from 'https://esm.sh/viem@2?bundle';
import { polygon } from 'https://esm.sh/viem/chains?bundle';

const CONTRACT = '0xd0163c60bd67bbf0e3c1bdabae50277dffb5583b';

const ABI = parseAbi([
  'function name() view returns (string)',
  'function symbol() view returns (string)',
  // 直ミント用の汎用候補。存在しなければエラーになるのでcatchする
  'function mint(uint256 quantity) payable',
  'function publicMint(uint256 quantity) payable'
]);

const out = (m) => document.getElementById('out').textContent = m;
const client = createWalletClient({ chain: polygon, transport: custom(window.ethereum) });

async function ensurePolygon(){
  const id = await window.ethereum.request({ method:'eth_chainId' });
  if (id !== '0x89') await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId:'0x89' }]});
}

document.getElementById('connect').onclick = async () => {
  if (!window.ethereum) return out('MetaMask未検出');
  await window.ethereum.request({ method:'eth_requestAccounts' });
  out('connected');
};

document.getElementById('probe').onclick = async () => {
  try{
    await ensurePolygon();
    const name = await readContract({ address: CONTRACT, abi: ABI, functionName: 'name' });
    const symbol = await readContract({ address: CONTRACT, abi: ABI, functionName: 'symbol' });
    out(`name: ${name}\nsymbol: ${symbol}\nOK: コントラクト到達`);
  }catch(e){ out('読取失敗: ' + (e?.message || e)); }
};

document.getElementById('mint').onclick = async () => {
  try{
    await ensurePolygon();
    const qty = BigInt(Math.max(1, Number(document.getElementById('q').value|0)));
    // 価格取得が不明なのでデフォルト0。必要なら固定値に変更
    const value = 0n;

    // まず mint(uint256) を試す → 失敗なら publicMint(uint256)
    try{
      await simulateContract({ address: CONTRACT, abi: ABI, functionName: 'mint', args:[qty], value });
      const tx = await writeContract({ address: CONTRACT, abi: ABI, functionName: 'mint', args:[qty], value });
      return out('tx: ' + tx);
    }catch{}
    await simulateContract({ address: CONTRACT, abi: ABI, functionName: 'publicMint', args:[qty], value });
    const tx2 = await writeContract({ address: CONTRACT, abi: ABI, functionName: 'publicMint', args:[qty], value });
    out('tx: ' + tx2);
  }catch(e){
    out('mint不可の可能性（SeaDrop/Studio/AL制御など）: ' + (e?.message || e));
  }
};
</script>
